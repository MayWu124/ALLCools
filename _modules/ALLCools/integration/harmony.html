
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ALLCools.integration.harmony</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-codeautolink.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/allcools_favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4F8CRF0GK9"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-4F8CRF0GK9');
                </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/allcools_logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../intro.html">
   ALLCools: ALL methyl-Cytosine tools
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  GET STARTED
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../start/installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../start/input_files.html">
   Input Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../start/analysis_steps.html">
   Analysis Steps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../start/interactive.html">
   Examples In This Document
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  CELLULAR ANALYSIS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cell_level/basic/intro_basic_clustering.html">
   Basic Clustering Walk-through
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/basic/mch_mcg_100k_basic.html">
     Basic Cell Clustering Using 100Kb Bins
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/basic/mcg_5kb_basic.html">
     Basic Cell Clustering Using mCG-5Kb Bins
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cell_level/step_by_step/intro_step_by_step_clustering.html">
   Step-by-step Clustering Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../cell_level/step_by_step/100kb/intro_100kb.html">
     Step-by-step Clustering Using 100Kb bins
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/01-CellBasicFiltering.html">
       Cell Basic Filtering
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/02-BasicFeatureFiltering.html">
       Feature Basic Filtering
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/03-HighlyVariableFeatureSelection.html">
       Calculate Highly Variable Features And Get mC Fraction AnnData
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/04a-PreclusteringAndClusterEnrichedFeatures-mCH.html">
       Preclustering and Cluster Enriched Features
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/04b-PreclusteringAndClusterEnrichedFeatures-mCG.html">
       Preclustering and Cluster Enriched Features
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/05-DecompositionAndEmbedding.html">
       Decomposition And Embedding
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/100kb/06-Clustering.html">
       Consensus Clustering
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../cell_level/step_by_step/5kb/intro_5kb.html">
     Step-by-step Clustering using mCG-5Kb Input
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/5kb/01-CellBasicFiltering.html">
       Cell Basic Filtering
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/5kb/02-DecompositionAndEmbedding.html">
       Decomposition Using mCG-5Kb Bins
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../cell_level/step_by_step/5kb/03-Clustering.html">
       Consensus Clustering
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cell_level/dmg/intro_dmg.html">
   Differential Methylated Genes Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/dmg/01-AddGenemCFractions.html">
     Calculate Gene mC Fractions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/dmg/02-DifferentiallyMethylatedGenes.html">
     Cluster Differentially Methylated Genes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/dmg/03-PlotClusterDMGs.html">
     Plot Cluster DMGs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/dmg/04-PairwiseDMG.html">
     Differential Methylated Genes - Pairwise
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cell_level/integration/intro_integration.html">
   Data Integration
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/integration/multi_modalities/Neurons/01-preprocess_10x.html">
     Preprocess 10X snRNA-seq
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/integration/multi_modalities/Neurons/02-preprocess_SMART.html">
     Preprocess SMART-seq
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/integration/multi_modalities/Neurons/03-preprocess_snATAC.html">
     Preprocess snATAC-seq
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/integration/multi_modalities/Neurons/04-integration.html">
     Perform Cross-Modality Integration
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cell_level/doublets/intro_doublets.html">
   Doublets Identification
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cell_level/doublets/doublet_score_chrom100k.html">
     Calculate Cell Doublet Score
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  GENOMIC ANALYSIS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cluster_level/intro.html">
   Post-clustering Genomic Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/01a.call_dmr.html">
     DMR Calling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/01b.other_option_to_init_region_ds.html">
     Alternative Way to Create RegionDS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/02.annotation.html">
     Annotate RegionDS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/03.filter_dmr.html">
     Filter DMR
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cluster_level/RegionDS/intro_motif.html">
   Motif Scan and Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/04.motif_scan.html">
     Motif Scan
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/RegionDS/05.motif_enrichment.html">
     Motif Enrichment Analysis
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cluster_level/Correlation/intro_corr.html">
   Region-Region Correlation Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/Correlation/01.mc_cluster_profile.html">
     Prepare Cluster-by-Gene mC Profile
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/Correlation/02.dmr_gene_corr.html">
     DMR-Gene Correlation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../cluster_level/REPTILE/intro_reptile.html">
   REPTILE
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/REPTILE/01.prepare_input.html">
     Prepare REPTILE
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../cluster_level/REPTILE/02.run_reptile.html">
     Predict Enhancer with REPTILE Algorithm
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  COMMAND LINE TOOLS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools.html">
   Entry Point
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_allc.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     allc
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_standard.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     standard
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_profile.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     profile
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_tbi.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     tbi
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_merge.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     merge
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_extract.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     extract
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_bw.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     bw
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_region.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     region
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_dataset.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     generate-dataset
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_mcds.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     mcds
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_mcad.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     mcad
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../command_line/allcools_table_to_allc.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     allcools
    </span>
    <span class="pre">
     tbi
    </span>
   </code>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../api/ALLCools/index.html">
   <code class="xref py py-mod docutils literal notranslate">
    <span class="pre">
     ALLCools
    </span>
   </code>
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/abc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.abc
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
    <label for="toctree-checkbox-13">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/abc/abc_score/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.abc.abc_score
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/clustering/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.clustering
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
    <label for="toctree-checkbox-14">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../api/ALLCools/clustering/doublets/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.doublets
        </span>
       </code>
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
      <label for="toctree-checkbox-15">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/clustering/doublets/coverage_doublets/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.clustering.doublets.coverage_doublets
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/clustering/doublets/scrublet/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.clustering.doublets.scrublet
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../api/ALLCools/clustering/feature_selection/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.feature_selection
        </span>
       </code>
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
      <label for="toctree-checkbox-16">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/clustering/feature_selection/feature_enrichment/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.clustering.feature_selection.feature_enrichment
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/clustering/feature_selection/gene_panel_design/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.clustering.feature_selection.gene_panel_design
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/ClusterMerging/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.ClusterMerging
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/ConsensusClustering/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.ConsensusClustering
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/art_of_tsne/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.art_of_tsne
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/balanced_pca/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.balanced_pca
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/dmg/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.dmg
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/incremental_pca/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.incremental_pca
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/mcad/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.mcad
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/clustering/pvclust/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.clustering.pvclust
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/count_matrix/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.count_matrix
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
    <label for="toctree-checkbox-17">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/atac/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.atac
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/dataset/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.dataset
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/h5ad/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.h5ad
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/mcad/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.mcad
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/mcds/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.mcds
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/snap/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.snap
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/count_matrix/zarr/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.count_matrix.zarr
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/dmr/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.dmr
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
    <label for="toctree-checkbox-18">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/dmr/call_dmr/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.dmr.call_dmr
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/dmr/call_dms/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.dmr.call_dms
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/dmr/parse_methylpy/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.dmr.parse_methylpy
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/dmr/rms_test/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.dmr.rms_test
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/gtf/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.gtf
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
    <label for="toctree-checkbox-19">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/gtf/Gtf/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.gtf.Gtf
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/gtf/utilities/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.gtf.utilities
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/integration/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.integration
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/>
    <label for="toctree-checkbox-20">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/integration/cca/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.integration.cca
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/integration/confusion/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.integration.confusion
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/integration/harmony/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.integration.harmony
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/mcds/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.mcds
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/>
    <label for="toctree-checkbox-21">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/mcds/correlation/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.mcds.correlation
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/mcds/mcds/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.mcds.mcds
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/mcds/region_ds/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.mcds.region_ds
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/mcds/utilities/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.mcds.utilities
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/motif/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.motif
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/>
    <label for="toctree-checkbox-22">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/motif/default_motif_set/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.motif.default_motif_set
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/motif/motifs/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.motif.motifs
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/motif/parse_meme/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.motif.parse_meme
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/motif/snakemake/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.motif.snakemake
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/plot/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.plot
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/>
    <label for="toctree-checkbox-23">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../api/ALLCools/plot/genome_track/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.genome_track
        </span>
       </code>
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/>
      <label for="toctree-checkbox-24">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/plot/genome_track/GtfTrack/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.plot.genome_track.GtfTrack
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/plot/genome_track/HiCMatrixCoolTrack/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.plot.genome_track.HiCMatrixCoolTrack
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/plot/genome_track/_pygenometrack/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.plot.genome_track._pygenometrack
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/categorical_scatter/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.categorical_scatter
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/color/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.color
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/continuous_scatter/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.continuous_scatter
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/contour/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.contour
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/decomposition/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.decomposition
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/dendro/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.dendro
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/interactive_scatter/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.interactive_scatter
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/qc_plots/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.qc_plots
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/size/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.size
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/sunburst/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.sunburst
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/text_anno_scatter/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.text_anno_scatter
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/plot/utilities/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.plot.utilities
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/pseudo_cell/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.pseudo_cell
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/>
    <label for="toctree-checkbox-25">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/pseudo_cell/pseudo_cell_kmeans/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.pseudo_cell.pseudo_cell_kmeans
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/pseudo_cell/pseudo_cell_knn/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.pseudo_cell.pseudo_cell_knn
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/reptile/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.reptile
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/>
    <label for="toctree-checkbox-26">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/reptile/reptile/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.reptile.reptile
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/sandbox/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.sandbox
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" type="checkbox"/>
    <label for="toctree-checkbox-27">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.sandbox.igv
        </span>
       </code>
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" type="checkbox"/>
      <label for="toctree-checkbox-28">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/BaseClass/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.igv.BaseClass
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/Session/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.igv.Session
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/Track/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.igv.Track
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/defaults/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.igv.defaults
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/igv/make_session/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.igv.make_session
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.sandbox.motif
        </span>
       </code>
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" type="checkbox"/>
      <label for="toctree-checkbox-29">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/ame/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.motif.ame
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/cmotif/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.motif.cmotif
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/fimo/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.motif.fimo
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/motif_scan/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.motif.motif_scan
          </span>
         </code>
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../../../api/ALLCools/sandbox/motif/utilities/index.html">
         <code class="xref py py-mod docutils literal notranslate">
          <span class="pre">
           ALLCools.sandbox.motif.utilities
          </span>
         </code>
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/sandbox/balanced_knn/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.sandbox.balanced_knn
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/sandbox/scanorama/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.sandbox.scanorama
        </span>
       </code>
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/sandbox/sccaf/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.sandbox.sccaf
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../api/ALLCools/schema/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.schema
      </span>
     </code>
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" type="checkbox"/>
    <label for="toctree-checkbox-30">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../api/ALLCools/schema/mcds_schema/index.html">
       <code class="xref py py-mod docutils literal notranslate">
        <span class="pre">
         ALLCools.schema.mcds_schema
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/__main__/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.__main__
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_allc_to_bigwig/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._allc_to_bigwig
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_allc_to_bigwig_new/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._allc_to_bigwig_new
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_allc_to_region_count/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._allc_to_region_count
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_bam_to_allc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._bam_to_allc
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_doc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._doc
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_extract_allc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._extract_allc
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_merge_allc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._merge_allc
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_open/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._open
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/_version/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools._version
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/api/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.api
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/table_to_allc/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.table_to_allc
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../api/ALLCools/utilities/index.html">
     <code class="xref py py-mod docutils literal notranslate">
      <span class="pre">
       ALLCools.utilities
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  PROJECT INFO
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../project_info/citation.html">
   Citation And Reference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/lhqing/ALLCools/releases">
   Changelog
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/lhqing/ALLCools"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/lhqing/ALLCools/issues/new?title=Issue%20on%20page%20%2F_modules/ALLCools/integration/harmony.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            
              <div>
                
  <h1>Source code for ALLCools.integration.harmony</h1><div class="highlight"><pre>
<span></span><span class="c1"># harmonypy - A data alignment algorithm.</span>
<span class="c1"># Copyright (C) 2018  Ilya Korsunsky</span>
<span class="c1">#               2019  Kamil Slowikowski &lt;kslowikowski@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.vq</span> <span class="kn">import</span> <span class="n">kmeans</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">anndata</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>

<span class="c1"># create logger</span>
<div class="viewcode-block" id="logger"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.logger">[docs]</a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;harmonypy&quot;</span><span class="p">)</span></div>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<div class="viewcode-block" id="ch"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.ch">[docs]</a><span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span></div>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<div class="viewcode-block" id="formatter"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.formatter">[docs]</a><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span></div>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>


<div class="viewcode-block" id="leiden_centroids"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.leiden_centroids">[docs]</a><span class="k">def</span> <span class="nf">leiden_centroids</span><span class="p">(</span><span class="n">pcs</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instead of kmeans, using leiden algorithm to find centroids&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_pcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_pcs</span> <span class="o">=</span> <span class="n">pcs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fake_adata</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pcs</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">fake_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_pca&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcs</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">fake_adata</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="n">n_pcs</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">fake_adata</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>

    <span class="c1"># get centroid</span>
    <span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fake_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_pca&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">fake_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span>
    <span class="n">centroids</span> <span class="o">=</span> <span class="n">pc_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">fake_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;leiden&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">centroids</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="run_harmony"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.run_harmony">[docs]</a><span class="k">def</span> <span class="nf">run_harmony</span><span class="p">(</span>
    <span class="n">data_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">meta_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">vars_use</span><span class="p">,</span>
    <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">nclust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tau</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">block_size</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">max_iter_harmony</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_iter_kmeans</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">epsilon_cluster</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">epsilon_harmony</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">init_method</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span>
    <span class="n">n_pcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">resolution</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">leiden_input</span><span class="o">=</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run Harmony.&quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
        <span class="n">data_mat</span> <span class="o">=</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">T</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span>
    <span class="p">),</span> <span class="s2">&quot;data_mat and meta_data do not have the same number of cells&quot;</span>

    <span class="k">if</span> <span class="n">nclust</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nclust</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="mf">30.0</span><span class="p">),</span> <span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">init_method</span> <span class="o">==</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">nclust</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">nclust</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vars_use</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">vars_use</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_use</span><span class="p">]</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">meta_data</span><span class="p">[</span><span class="n">vars_use</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">phi_n</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="n">vars_use</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="n">phi_n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">theta</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="n">phi_n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">theta</span><span class="p">],</span> <span class="n">phi_n</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="s2">&quot;each batch variable must have a theta&quot;</span>

    <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="n">phi_n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">lamb</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="n">phi_n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_n</span><span class="p">):</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">lamb</span><span class="p">],</span> <span class="n">phi_n</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">phi_n</span><span class="p">),</span> <span class="s2">&quot;each batch variable must have a lambda&quot;</span>

    <span class="c1"># Number of items in each category.</span>
    <span class="n">N_b</span> <span class="o">=</span> <span class="n">phi</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Proportion of items in each category.</span>
    <span class="n">Pr_b</span> <span class="o">=</span> <span class="n">N_b</span> <span class="o">/</span> <span class="n">N</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">init_method</span> <span class="o">==</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># tau = 0 by default</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">N_b</span> <span class="o">/</span> <span class="p">(</span><span class="n">nclust</span> <span class="o">*</span> <span class="n">tau</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)))</span>

    <span class="n">lamb_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">phi_moe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">phi</span><span class="p">))</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>

    <span class="n">ho</span> <span class="o">=</span> <span class="n">Harmony</span><span class="p">(</span>
        <span class="n">data_mat</span><span class="p">,</span>
        <span class="n">phi</span><span class="p">,</span>
        <span class="n">phi_moe</span><span class="p">,</span>
        <span class="n">Pr_b</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
        <span class="n">theta</span><span class="p">,</span>
        <span class="n">max_iter_harmony</span><span class="p">,</span>
        <span class="n">max_iter_kmeans</span><span class="p">,</span>
        <span class="n">epsilon_cluster</span><span class="p">,</span>
        <span class="n">epsilon_harmony</span><span class="p">,</span>
        <span class="n">nclust</span><span class="p">,</span>
        <span class="n">block_size</span><span class="p">,</span>
        <span class="n">lamb_mat</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">init_method</span><span class="p">,</span>
        <span class="n">n_pcs</span><span class="p">,</span>
        <span class="n">n_neighbors</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="n">leiden_input</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ho</span></div>


<div class="viewcode-block" id="Harmony"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony">[docs]</a><span class="k">class</span> <span class="nc">Harmony</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Z</span><span class="p">,</span>
        <span class="n">Phi</span><span class="p">,</span>
        <span class="n">Phi_moe</span><span class="p">,</span>
        <span class="n">Pr_b</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
        <span class="n">theta</span><span class="p">,</span>
        <span class="n">max_iter_harmony</span><span class="p">,</span>
        <span class="n">max_iter_kmeans</span><span class="p">,</span>
        <span class="n">epsilon_kmeans</span><span class="p">,</span>
        <span class="n">epsilon_harmony</span><span class="p">,</span>
        <span class="n">K</span><span class="p">,</span>
        <span class="n">block_size</span><span class="p">,</span>
        <span class="n">lamb</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">init_method</span><span class="p">,</span>
        <span class="n">n_pcs</span><span class="p">,</span>
        <span class="n">n_neighbors</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="n">leiden_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_orig</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_orig</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span> <span class="o">=</span> <span class="n">Phi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Phi_moe</span> <span class="o">=</span> <span class="n">Phi_moe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pr_b</span> <span class="o">=</span> <span class="n">Pr_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of batch variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_kmeans</span> <span class="o">=</span> <span class="n">epsilon_kmeans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_harmony</span> <span class="o">=</span> <span class="n">epsilon_harmony</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_prior</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>  <span class="c1"># number of clusters, not used if init_method is leiden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter_harmony</span> <span class="o">=</span> <span class="n">max_iter_harmony</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter_kmeans</span> <span class="o">=</span> <span class="n">max_iter_kmeans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_method</span> <span class="o">=</span> <span class="n">init_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pcs</span> <span class="o">=</span> <span class="n">n_pcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">n_neighbors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leiden_input</span> <span class="o">=</span> <span class="n">leiden_input</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">objective_harmony</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_dist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_entropy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_cross</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans_rounds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_cluster</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">harmonize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter_harmony</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

<div class="viewcode-block" id="Harmony.result"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.result">[docs]</a>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span></div>

<div class="viewcode-block" id="Harmony.allocate_buffers"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.allocate_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">allocate_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Phi_Rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span></div>

<div class="viewcode-block" id="Harmony.init_cluster"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.init_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">init_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Start with cluster centroids</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_method</span> <span class="o">==</span> <span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_orig</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leiden_input</span> <span class="o">==</span> <span class="s2">&quot;origin&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="o">.</span><span class="n">T</span>
            <span class="n">km</span> <span class="o">=</span> <span class="n">leiden_centroids</span><span class="p">(</span>
                <span class="n">_input</span><span class="p">,</span>
                <span class="n">n_pcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pcs</span><span class="p">,</span>
                <span class="n">n_neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_neighbors</span><span class="p">,</span>
                <span class="n">resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># update K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">km</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using leiden centroids as init, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="si">}</span><span class="s2"> clusters&quot;</span><span class="p">)</span>

            <span class="c1"># need to reinit sigma and theta because K changed</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_buffers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">km</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># (1) Normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># (2) Assign cluster probabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># (3) Batch diversity statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pr_b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_objective</span><span class="p">()</span>
        <span class="c1"># Save results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_harmony</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Harmony.compute_objective"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.compute_objective">[docs]</a>    <span class="k">def</span> <span class="nf">compute_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kmeans_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span><span class="p">))</span>
        <span class="c1"># Entropy</span>
        <span class="n">_entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">safe_entropy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="c1"># Cross Entropy</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">)</span>
        <span class="n">_cross_entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
        <span class="c1"># Save results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans_error</span> <span class="o">+</span> <span class="n">_entropy</span> <span class="o">+</span> <span class="n">_cross_entropy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_entropy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_entropy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans_cross</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_cross_entropy</span><span class="p">)</span></div>

<div class="viewcode-block" id="Harmony.harmonize"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.harmonize">[docs]</a>    <span class="k">def</span> <span class="nf">harmonize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iter_harmony</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">iter_harmony</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iteration </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iter_harmony</span><span class="p">))</span>
            <span class="c1"># STEP 1: Clustering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">()</span>
            <span class="c1"># STEP 2: Regress out covariates</span>
            <span class="c1"># self.moe_correct_ridge()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi_Rk</span> <span class="o">=</span> <span class="n">moe_correct_ridge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z_orig</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z_corr</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phi_Rk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phi_moe</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># STEP 3: Check for convergence</span>
            <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Converged after </span><span class="si">{}</span><span class="s2"> iteration</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopped before convergence&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Harmony.cluster"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.cluster">[docs]</a>    <span class="k">def</span> <span class="nf">cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Z_cos has changed</span>
        <span class="c1"># R is assumed to not have changed</span>
        <span class="c1"># Update Y to match new integrated data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter_kmeans</span><span class="p">):</span>
            <span class="c1"># print(&quot;kmeans {}&quot;.format(i))</span>
            <span class="c1"># STEP 1: Update Y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># STEP 2: Update dist_mat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_cos</span><span class="p">))</span>
            <span class="c1"># STEP 3: Update R</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_R</span><span class="p">()</span>
            <span class="c1"># STEP 4: Check for convergence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_objective</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_convergence</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmeans_rounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_harmony</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Harmony.update_R"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.update_R">[docs]</a>    <span class="k">def</span> <span class="nf">update_R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_mat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span><span class="p">)</span>
        <span class="c1"># Update cells in blocks</span>
        <span class="n">update_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">update_order</span><span class="p">)</span>
        <span class="n">n_blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">blocks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">update_order</span><span class="p">,</span> <span class="n">n_blocks</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="c1"># STEP 1: Remove cells</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pr_b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="c1"># STEP 2: Recompute R for removed cells</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale_dist</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># STEP 3: Put cells back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pr_b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[:,</span> <span class="n">b</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phi</span><span class="p">[:,</span> <span class="n">b</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Harmony.check_convergence"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.Harmony.check_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">check_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_type</span><span class="p">):</span>
        <span class="n">obj_old</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">obj_new</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Clustering, compute new window mean</span>
        <span class="k">if</span> <span class="n">i_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">okl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">):</span>
                <span class="n">obj_old</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="p">[</span><span class="n">okl</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">obj_new</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_kmeans</span><span class="p">[</span><span class="n">okl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">obj_old</span> <span class="o">-</span> <span class="n">obj_new</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">obj_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_kmeans</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Harmony</span>
        <span class="k">if</span> <span class="n">i_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">obj_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_harmony</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">obj_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_harmony</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">obj_old</span> <span class="o">-</span> <span class="n">obj_new</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">obj_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_harmony</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="safe_entropy"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.safe_entropy">[docs]</a><span class="k">def</span> <span class="nf">safe_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="moe_correct_ridge"><a class="viewcode-back" href="../../../api/ALLCools/integration/harmony/index.html#ALLCools.integration.harmony.moe_correct_ridge">[docs]</a><span class="k">def</span> <span class="nf">moe_correct_ridge</span><span class="p">(</span><span class="n">Z_orig</span><span class="p">,</span> <span class="n">Z_cos</span><span class="p">,</span> <span class="n">Z_corr</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Phi_Rk</span><span class="p">,</span> <span class="n">Phi_moe</span><span class="p">,</span> <span class="n">lamb</span><span class="p">):</span>
    <span class="n">Z_corr</span> <span class="o">=</span> <span class="n">Z_orig</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
        <span class="n">Phi_Rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Phi_moe</span><span class="p">,</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Phi_Rk</span><span class="p">,</span> <span class="n">Phi_moe</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">lamb</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">Phi_Rk</span><span class="p">),</span> <span class="n">Z_orig</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># do not remove the intercept</span>
        <span class="n">Z_corr</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Phi_Rk</span><span class="p">)</span>
    <span class="n">Z_cos</span> <span class="o">=</span> <span class="n">Z_corr</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Z_corr</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z_cos</span><span class="p">,</span> <span class="n">Z_corr</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">Phi_Rk</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    GNU GENERAL PUBLIC LICENSE</span>
<span class="sd">                       Version 3, 29 June 2007</span>

<span class="sd"> Copyright (C) 2007 Free Software Foundation, Inc. &lt;https://fsf.org/&gt;</span>
<span class="sd"> Everyone is permitted to copy and distribute verbatim copies</span>
<span class="sd"> of this license document, but changing it is not allowed.</span>

<span class="sd">                            Preamble</span>

<span class="sd">  The GNU General Public License is a free, copyleft license for</span>
<span class="sd">software and other kinds of works.</span>

<span class="sd">  The licenses for most software and other practical works are designed</span>
<span class="sd">to take away your freedom to share and change the works.  By contrast,</span>
<span class="sd">the GNU General Public License is intended to guarantee your freedom to</span>
<span class="sd">share and change all versions of a program--to make sure it remains free</span>
<span class="sd">software for all its users.  We, the Free Software Foundation, use the</span>
<span class="sd">GNU General Public License for most of our software; it applies also to</span>
<span class="sd">any other work released this way by its authors.  You can apply it to</span>
<span class="sd">your programs, too.</span>

<span class="sd">  When we speak of free software, we are referring to freedom, not</span>
<span class="sd">price.  Our General Public Licenses are designed to make sure that you</span>
<span class="sd">have the freedom to distribute copies of free software (and charge for</span>
<span class="sd">them if you wish), that you receive source code or can get it if you</span>
<span class="sd">want it, that you can change the software or use pieces of it in new</span>
<span class="sd">free programs, and that you know you can do these things.</span>

<span class="sd">  To protect your rights, we need to prevent others from denying you</span>
<span class="sd">these rights or asking you to surrender the rights.  Therefore, you have</span>
<span class="sd">certain responsibilities if you distribute copies of the software, or if</span>
<span class="sd">you modify it: responsibilities to respect the freedom of others.</span>

<span class="sd">  For example, if you distribute copies of such a program, whether</span>
<span class="sd">gratis or for a fee, you must pass on to the recipients the same</span>
<span class="sd">freedoms that you received.  You must make sure that they, too, receive</span>
<span class="sd">or can get the source code.  And you must show them these terms so they</span>
<span class="sd">know their rights.</span>

<span class="sd">  Developers that use the GNU GPL protect your rights with two steps:</span>
<span class="sd">(1) assert copyright on the software, and (2) offer you this License</span>
<span class="sd">giving you legal permission to copy, distribute and/or modify it.</span>

<span class="sd">  For the developers&#39; and authors&#39; protection, the GPL clearly explains</span>
<span class="sd">that there is no warranty for this free software.  For both users&#39; and</span>
<span class="sd">authors&#39; sake, the GPL requires that modified versions be marked as</span>
<span class="sd">changed, so that their problems will not be attributed erroneously to</span>
<span class="sd">authors of previous versions.</span>

<span class="sd">  Some devices are designed to deny users access to install or run</span>
<span class="sd">modified versions of the software inside them, although the manufacturer</span>
<span class="sd">can do so.  This is fundamentally incompatible with the aim of</span>
<span class="sd">protecting users&#39; freedom to change the software.  The systematic</span>
<span class="sd">pattern of such abuse occurs in the area of products for individuals to</span>
<span class="sd">use, which is precisely where it is most unacceptable.  Therefore, we</span>
<span class="sd">have designed this version of the GPL to prohibit the practice for those</span>
<span class="sd">products.  If such problems arise substantially in other domains, we</span>
<span class="sd">stand ready to extend this provision to those domains in future versions</span>
<span class="sd">of the GPL, as needed to protect the freedom of users.</span>

<span class="sd">  Finally, every program is threatened constantly by software patents.</span>
<span class="sd">States should not allow patents to restrict development and use of</span>
<span class="sd">software on general-purpose computers, but in those that do, we wish to</span>
<span class="sd">avoid the special danger that patents applied to a free program could</span>
<span class="sd">make it effectively proprietary.  To prevent this, the GPL assures that</span>
<span class="sd">patents cannot be used to render the program non-free.</span>

<span class="sd">  The precise terms and conditions for copying, distribution and</span>
<span class="sd">modification follow.</span>

<span class="sd">                       TERMS AND CONDITIONS</span>

<span class="sd">  0. Definitions.</span>

<span class="sd">  &quot;This License&quot; refers to version 3 of the GNU General Public License.</span>

<span class="sd">  &quot;Copyright&quot; also means copyright-like laws that apply to other kinds of</span>
<span class="sd">works, such as semiconductor masks.</span>

<span class="sd">  &quot;The Program&quot; refers to any copyrightable work licensed under this</span>
<span class="sd">License.  Each licensee is addressed as &quot;you&quot;.  &quot;Licensees&quot; and</span>
<span class="sd">&quot;recipients&quot; may be individuals or organizations.</span>

<span class="sd">  To &quot;modify&quot; a work means to copy from or adapt all or part of the work</span>
<span class="sd">in a fashion requiring copyright permission, other than the making of an</span>
<span class="sd">exact copy.  The resulting work is called a &quot;modified version&quot; of the</span>
<span class="sd">earlier work or a work &quot;based on&quot; the earlier work.</span>

<span class="sd">  A &quot;covered work&quot; means either the unmodified Program or a work based</span>
<span class="sd">on the Program.</span>

<span class="sd">  To &quot;propagate&quot; a work means to do anything with it that, without</span>
<span class="sd">permission, would make you directly or secondarily liable for</span>
<span class="sd">infringement under applicable copyright law, except executing it on a</span>
<span class="sd">computer or modifying a private copy.  Propagation includes copying,</span>
<span class="sd">distribution (with or without modification), making available to the</span>
<span class="sd">public, and in some countries other activities as well.</span>

<span class="sd">  To &quot;convey&quot; a work means any kind of propagation that enables other</span>
<span class="sd">parties to make or receive copies.  Mere interaction with a user through</span>
<span class="sd">a computer network, with no transfer of a copy, is not conveying.</span>

<span class="sd">  An interactive user interface displays &quot;Appropriate Legal Notices&quot;</span>
<span class="sd">to the extent that it includes a convenient and prominently visible</span>
<span class="sd">feature that (1) displays an appropriate copyright notice, and (2)</span>
<span class="sd">tells the user that there is no warranty for the work (except to the</span>
<span class="sd">extent that warranties are provided), that licensees may convey the</span>
<span class="sd">work under this License, and how to view a copy of this License.  If</span>
<span class="sd">the interface presents a list of user commands or options, such as a</span>
<span class="sd">menu, a prominent item in the list meets this criterion.</span>

<span class="sd">  1. Source Code.</span>

<span class="sd">  The &quot;source code&quot; for a work means the preferred form of the work</span>
<span class="sd">for making modifications to it.  &quot;Object code&quot; means any non-source</span>
<span class="sd">form of a work.</span>

<span class="sd">  A &quot;Standard Interface&quot; means an interface that either is an official</span>
<span class="sd">standard defined by a recognized standards body, or, in the case of</span>
<span class="sd">interfaces specified for a particular programming language, one that</span>
<span class="sd">is widely used among developers working in that language.</span>

<span class="sd">  The &quot;System Libraries&quot; of an executable work include anything, other</span>
<span class="sd">than the work as a whole, that (a) is included in the normal form of</span>
<span class="sd">packaging a Major Component, but which is not part of that Major</span>
<span class="sd">Component, and (b) serves only to enable use of the work with that</span>
<span class="sd">Major Component, or to implement a Standard Interface for which an</span>
<span class="sd">implementation is available to the public in source code form.  A</span>
<span class="sd">&quot;Major Component&quot;, in this context, means a major essential component</span>
<span class="sd">(kernel, window system, and so on) of the specific operating system</span>
<span class="sd">(if any) on which the executable work runs, or a compiler used to</span>
<span class="sd">produce the work, or an object code interpreter used to run it.</span>

<span class="sd">  The &quot;Corresponding Source&quot; for a work in object code form means all</span>
<span class="sd">the source code needed to generate, install, and (for an executable</span>
<span class="sd">work) run the object code and to modify the work, including scripts to</span>
<span class="sd">control those activities.  However, it does not include the work&#39;s</span>
<span class="sd">System Libraries, or general-purpose tools or generally available free</span>
<span class="sd">programs which are used unmodified in performing those activities but</span>
<span class="sd">which are not part of the work.  For example, Corresponding Source</span>
<span class="sd">includes interface definition files associated with source files for</span>
<span class="sd">the work, and the source code for shared libraries and dynamically</span>
<span class="sd">linked subprograms that the work is specifically designed to require,</span>
<span class="sd">such as by intimate data communication or control flow between those</span>
<span class="sd">subprograms and other parts of the work.</span>

<span class="sd">  The Corresponding Source need not include anything that users</span>
<span class="sd">can regenerate automatically from other parts of the Corresponding</span>
<span class="sd">Source.</span>

<span class="sd">  The Corresponding Source for a work in source code form is that</span>
<span class="sd">same work.</span>

<span class="sd">  2. Basic Permissions.</span>

<span class="sd">  All rights granted under this License are granted for the term of</span>
<span class="sd">copyright on the Program, and are irrevocable provided the stated</span>
<span class="sd">conditions are met.  This License explicitly affirms your unlimited</span>
<span class="sd">permission to run the unmodified Program.  The output from running a</span>
<span class="sd">covered work is covered by this License only if the output, given its</span>
<span class="sd">content, constitutes a covered work.  This License acknowledges your</span>
<span class="sd">rights of fair use or other equivalent, as provided by copyright law.</span>

<span class="sd">  You may make, run and propagate covered works that you do not</span>
<span class="sd">convey, without conditions so long as your license otherwise remains</span>
<span class="sd">in force.  You may convey covered works to others for the sole purpose</span>
<span class="sd">of having them make modifications exclusively for you, or provide you</span>
<span class="sd">with facilities for running those works, provided that you comply with</span>
<span class="sd">the terms of this License in conveying all material for which you do</span>
<span class="sd">not control copyright.  Those thus making or running the covered works</span>
<span class="sd">for you must do so exclusively on your behalf, under your direction</span>
<span class="sd">and control, on terms that prohibit them from making any copies of</span>
<span class="sd">your copyrighted material outside their relationship with you.</span>

<span class="sd">  Conveying under any other circumstances is permitted solely under</span>
<span class="sd">the conditions stated below.  Sublicensing is not allowed; section 10</span>
<span class="sd">makes it unnecessary.</span>

<span class="sd">  3. Protecting Users&#39; Legal Rights From Anti-Circumvention Law.</span>

<span class="sd">  No covered work shall be deemed part of an effective technological</span>
<span class="sd">measure under any applicable law fulfilling obligations under article</span>
<span class="sd">11 of the WIPO copyright treaty adopted on 20 December 1996, or</span>
<span class="sd">similar laws prohibiting or restricting circumvention of such</span>
<span class="sd">measures.</span>

<span class="sd">  When you convey a covered work, you waive any legal power to forbid</span>
<span class="sd">circumvention of technological measures to the extent such circumvention</span>
<span class="sd">is effected by exercising rights under this License with respect to</span>
<span class="sd">the covered work, and you disclaim any intention to limit operation or</span>
<span class="sd">modification of the work as a means of enforcing, against the work&#39;s</span>
<span class="sd">users, your or third parties&#39; legal rights to forbid circumvention of</span>
<span class="sd">technological measures.</span>

<span class="sd">  4. Conveying Verbatim Copies.</span>

<span class="sd">  You may convey verbatim copies of the Program&#39;s source code as you</span>
<span class="sd">receive it, in any medium, provided that you conspicuously and</span>
<span class="sd">appropriately publish on each copy an appropriate copyright notice;</span>
<span class="sd">keep intact all notices stating that this License and any</span>
<span class="sd">non-permissive terms added in accord with section 7 apply to the code;</span>
<span class="sd">keep intact all notices of the absence of any warranty; and give all</span>
<span class="sd">recipients a copy of this License along with the Program.</span>

<span class="sd">  You may charge any price or no price for each copy that you convey,</span>
<span class="sd">and you may offer support or warranty protection for a fee.</span>

<span class="sd">  5. Conveying Modified Source Versions.</span>

<span class="sd">  You may convey a work based on the Program, or the modifications to</span>
<span class="sd">produce it from the Program, in the form of source code under the</span>
<span class="sd">terms of section 4, provided that you also meet all of these conditions:</span>

<span class="sd">    a) The work must carry prominent notices stating that you modified</span>
<span class="sd">    it, and giving a relevant date.</span>

<span class="sd">    b) The work must carry prominent notices stating that it is</span>
<span class="sd">    released under this License and any conditions added under section</span>
<span class="sd">    7.  This requirement modifies the requirement in section 4 to</span>
<span class="sd">    &quot;keep intact all notices&quot;.</span>

<span class="sd">    c) You must license the entire work, as a whole, under this</span>
<span class="sd">    License to anyone who comes into possession of a copy.  This</span>
<span class="sd">    License will therefore apply, along with any applicable section 7</span>
<span class="sd">    additional terms, to the whole of the work, and all its parts,</span>
<span class="sd">    regardless of how they are packaged.  This License gives no</span>
<span class="sd">    permission to license the work in any other way, but it does not</span>
<span class="sd">    invalidate such permission if you have separately received it.</span>

<span class="sd">    d) If the work has interactive user interfaces, each must display</span>
<span class="sd">    Appropriate Legal Notices; however, if the Program has interactive</span>
<span class="sd">    interfaces that do not display Appropriate Legal Notices, your</span>
<span class="sd">    work need not make them do so.</span>

<span class="sd">  A compilation of a covered work with other separate and independent</span>
<span class="sd">works, which are not by their nature extensions of the covered work,</span>
<span class="sd">and which are not combined with it such as to form a larger program,</span>
<span class="sd">in or on a volume of a storage or distribution medium, is called an</span>
<span class="sd">&quot;aggregate&quot; if the compilation and its resulting copyright are not</span>
<span class="sd">used to limit the access or legal rights of the compilation&#39;s users</span>
<span class="sd">beyond what the individual works permit.  Inclusion of a covered work</span>
<span class="sd">in an aggregate does not cause this License to apply to the other</span>
<span class="sd">parts of the aggregate.</span>

<span class="sd">  6. Conveying Non-Source Forms.</span>

<span class="sd">  You may convey a covered work in object code form under the terms</span>
<span class="sd">of sections 4 and 5, provided that you also convey the</span>
<span class="sd">machine-readable Corresponding Source under the terms of this License,</span>
<span class="sd">in one of these ways:</span>

<span class="sd">    a) Convey the object code in, or embodied in, a physical product</span>
<span class="sd">    (including a physical distribution medium), accompanied by the</span>
<span class="sd">    Corresponding Source fixed on a durable physical medium</span>
<span class="sd">    customarily used for software interchange.</span>

<span class="sd">    b) Convey the object code in, or embodied in, a physical product</span>
<span class="sd">    (including a physical distribution medium), accompanied by a</span>
<span class="sd">    written offer, valid for at least three years and valid for as</span>
<span class="sd">    long as you offer spare parts or customer support for that product</span>
<span class="sd">    model, to give anyone who possesses the object code either (1) a</span>
<span class="sd">    copy of the Corresponding Source for all the software in the</span>
<span class="sd">    product that is covered by this License, on a durable physical</span>
<span class="sd">    medium customarily used for software interchange, for a price no</span>
<span class="sd">    more than your reasonable cost of physically performing this</span>
<span class="sd">    conveying of source, or (2) access to copy the</span>
<span class="sd">    Corresponding Source from a network server at no charge.</span>

<span class="sd">    c) Convey individual copies of the object code with a copy of the</span>
<span class="sd">    written offer to provide the Corresponding Source.  This</span>
<span class="sd">    alternative is allowed only occasionally and noncommercially, and</span>
<span class="sd">    only if you received the object code with such an offer, in accord</span>
<span class="sd">    with subsection 6b.</span>

<span class="sd">    d) Convey the object code by offering access from a designated</span>
<span class="sd">    place (gratis or for a charge), and offer equivalent access to the</span>
<span class="sd">    Corresponding Source in the same way through the same place at no</span>
<span class="sd">    further charge.  You need not require recipients to copy the</span>
<span class="sd">    Corresponding Source along with the object code.  If the place to</span>
<span class="sd">    copy the object code is a network server, the Corresponding Source</span>
<span class="sd">    may be on a different server (operated by you or a third party)</span>
<span class="sd">    that supports equivalent copying facilities, provided you maintain</span>
<span class="sd">    clear directions next to the object code saying where to find the</span>
<span class="sd">    Corresponding Source.  Regardless of what server hosts the</span>
<span class="sd">    Corresponding Source, you remain obligated to ensure that it is</span>
<span class="sd">    available for as long as needed to satisfy these requirements.</span>

<span class="sd">    e) Convey the object code using peer-to-peer transmission, provided</span>
<span class="sd">    you inform other peers where the object code and Corresponding</span>
<span class="sd">    Source of the work are being offered to the general public at no</span>
<span class="sd">    charge under subsection 6d.</span>

<span class="sd">  A separable portion of the object code, whose source code is excluded</span>
<span class="sd">from the Corresponding Source as a System Library, need not be</span>
<span class="sd">included in conveying the object code work.</span>

<span class="sd">  A &quot;User Product&quot; is either (1) a &quot;consumer product&quot;, which means any</span>
<span class="sd">tangible personal property which is normally used for personal, family,</span>
<span class="sd">or household purposes, or (2) anything designed or sold for incorporation</span>
<span class="sd">into a dwelling.  In determining whether a product is a consumer product,</span>
<span class="sd">doubtful cases shall be resolved in favor of coverage.  For a particular</span>
<span class="sd">product received by a particular user, &quot;normally used&quot; refers to a</span>
<span class="sd">typical or common use of that class of product, regardless of the status</span>
<span class="sd">of the particular user or of the way in which the particular user</span>
<span class="sd">actually uses, or expects or is expected to use, the product.  A product</span>
<span class="sd">is a consumer product regardless of whether the product has substantial</span>
<span class="sd">commercial, industrial or non-consumer uses, unless such uses represent</span>
<span class="sd">the only significant mode of use of the product.</span>

<span class="sd">  &quot;Installation Information&quot; for a User Product means any methods,</span>
<span class="sd">procedures, authorization keys, or other information required to install</span>
<span class="sd">and execute modified versions of a covered work in that User Product from</span>
<span class="sd">a modified version of its Corresponding Source.  The information must</span>
<span class="sd">suffice to ensure that the continued functioning of the modified object</span>
<span class="sd">code is in no case prevented or interfered with solely because</span>
<span class="sd">modification has been made.</span>

<span class="sd">  If you convey an object code work under this section in, or with, or</span>
<span class="sd">specifically for use in, a User Product, and the conveying occurs as</span>
<span class="sd">part of a transaction in which the right of possession and use of the</span>
<span class="sd">User Product is transferred to the recipient in perpetuity or for a</span>
<span class="sd">fixed term (regardless of how the transaction is characterized), the</span>
<span class="sd">Corresponding Source conveyed under this section must be accompanied</span>
<span class="sd">by the Installation Information.  But this requirement does not apply</span>
<span class="sd">if neither you nor any third party retains the ability to install</span>
<span class="sd">modified object code on the User Product (for example, the work has</span>
<span class="sd">been installed in ROM).</span>

<span class="sd">  The requirement to provide Installation Information does not include a</span>
<span class="sd">requirement to continue to provide support service, warranty, or updates</span>
<span class="sd">for a work that has been modified or installed by the recipient, or for</span>
<span class="sd">the User Product in which it has been modified or installed.  Access to a</span>
<span class="sd">network may be denied when the modification itself materially and</span>
<span class="sd">adversely affects the operation of the network or violates the rules and</span>
<span class="sd">protocols for communication across the network.</span>

<span class="sd">  Corresponding Source conveyed, and Installation Information provided,</span>
<span class="sd">in accord with this section must be in a format that is publicly</span>
<span class="sd">documented (and with an implementation available to the public in</span>
<span class="sd">source code form), and must require no special password or key for</span>
<span class="sd">unpacking, reading or copying.</span>

<span class="sd">  7. Additional Terms.</span>

<span class="sd">  &quot;Additional permissions&quot; are terms that supplement the terms of this</span>
<span class="sd">License by making exceptions from one or more of its conditions.</span>
<span class="sd">Additional permissions that are applicable to the entire Program shall</span>
<span class="sd">be treated as though they were included in this License, to the extent</span>
<span class="sd">that they are valid under applicable law.  If additional permissions</span>
<span class="sd">apply only to part of the Program, that part may be used separately</span>
<span class="sd">under those permissions, but the entire Program remains governed by</span>
<span class="sd">this License without regard to the additional permissions.</span>

<span class="sd">  When you convey a copy of a covered work, you may at your option</span>
<span class="sd">remove any additional permissions from that copy, or from any part of</span>
<span class="sd">it.  (Additional permissions may be written to require their own</span>
<span class="sd">removal in certain cases when you modify the work.)  You may place</span>
<span class="sd">additional permissions on material, added by you to a covered work,</span>
<span class="sd">for which you have or can give appropriate copyright permission.</span>

<span class="sd">  Notwithstanding any other provision of this License, for material you</span>
<span class="sd">add to a covered work, you may (if authorized by the copyright holders of</span>
<span class="sd">that material) supplement the terms of this License with terms:</span>

<span class="sd">    a) Disclaiming warranty or limiting liability differently from the</span>
<span class="sd">    terms of sections 15 and 16 of this License; or</span>

<span class="sd">    b) Requiring preservation of specified reasonable legal notices or</span>
<span class="sd">    author attributions in that material or in the Appropriate Legal</span>
<span class="sd">    Notices displayed by works containing it; or</span>

<span class="sd">    c) Prohibiting misrepresentation of the origin of that material, or</span>
<span class="sd">    requiring that modified versions of such material be marked in</span>
<span class="sd">    reasonable ways as different from the original version; or</span>

<span class="sd">    d) Limiting the use for publicity purposes of names of licensors or</span>
<span class="sd">    authors of the material; or</span>

<span class="sd">    e) Declining to grant rights under trademark law for use of some</span>
<span class="sd">    trade names, trademarks, or service marks; or</span>

<span class="sd">    f) Requiring indemnification of licensors and authors of that</span>
<span class="sd">    material by anyone who conveys the material (or modified versions of</span>
<span class="sd">    it) with contractual assumptions of liability to the recipient, for</span>
<span class="sd">    any liability that these contractual assumptions directly impose on</span>
<span class="sd">    those licensors and authors.</span>

<span class="sd">  All other non-permissive additional terms are considered &quot;further</span>
<span class="sd">restrictions&quot; within the meaning of section 10.  If the Program as you</span>
<span class="sd">received it, or any part of it, contains a notice stating that it is</span>
<span class="sd">governed by this License along with a term that is a further</span>
<span class="sd">restriction, you may remove that term.  If a license document contains</span>
<span class="sd">a further restriction but permits relicensing or conveying under this</span>
<span class="sd">License, you may add to a covered work material governed by the terms</span>
<span class="sd">of that license document, provided that the further restriction does</span>
<span class="sd">not survive such relicensing or conveying.</span>

<span class="sd">  If you add terms to a covered work in accord with this section, you</span>
<span class="sd">must place, in the relevant source files, a statement of the</span>
<span class="sd">additional terms that apply to those files, or a notice indicating</span>
<span class="sd">where to find the applicable terms.</span>

<span class="sd">  Additional terms, permissive or non-permissive, may be stated in the</span>
<span class="sd">form of a separately written license, or stated as exceptions;</span>
<span class="sd">the above requirements apply either way.</span>

<span class="sd">  8. Termination.</span>

<span class="sd">  You may not propagate or modify a covered work except as expressly</span>
<span class="sd">provided under this License.  Any attempt otherwise to propagate or</span>
<span class="sd">modify it is void, and will automatically terminate your rights under</span>
<span class="sd">this License (including any patent licenses granted under the third</span>
<span class="sd">paragraph of section 11).</span>

<span class="sd">  However, if you cease all violation of this License, then your</span>
<span class="sd">license from a particular copyright holder is reinstated (a)</span>
<span class="sd">provisionally, unless and until the copyright holder explicitly and</span>
<span class="sd">finally terminates your license, and (b) permanently, if the copyright</span>
<span class="sd">holder fails to notify you of the violation by some reasonable means</span>
<span class="sd">prior to 60 days after the cessation.</span>

<span class="sd">  Moreover, your license from a particular copyright holder is</span>
<span class="sd">reinstated permanently if the copyright holder notifies you of the</span>
<span class="sd">violation by some reasonable means, this is the first time you have</span>
<span class="sd">received notice of violation of this License (for any work) from that</span>
<span class="sd">copyright holder, and you cure the violation prior to 30 days after</span>
<span class="sd">your receipt of the notice.</span>

<span class="sd">  Termination of your rights under this section does not terminate the</span>
<span class="sd">licenses of parties who have received copies or rights from you under</span>
<span class="sd">this License.  If your rights have been terminated and not permanently</span>
<span class="sd">reinstated, you do not qualify to receive new licenses for the same</span>
<span class="sd">material under section 10.</span>

<span class="sd">  9. Acceptance Not Required for Having Copies.</span>

<span class="sd">  You are not required to accept this License in order to receive or</span>
<span class="sd">run a copy of the Program.  Ancillary propagation of a covered work</span>
<span class="sd">occurring solely as a consequence of using peer-to-peer transmission</span>
<span class="sd">to receive a copy likewise does not require acceptance.  However,</span>
<span class="sd">nothing other than this License grants you permission to propagate or</span>
<span class="sd">modify any covered work.  These actions infringe copyright if you do</span>
<span class="sd">not accept this License.  Therefore, by modifying or propagating a</span>
<span class="sd">covered work, you indicate your acceptance of this License to do so.</span>

<span class="sd">  10. Automatic Licensing of Downstream Recipients.</span>

<span class="sd">  Each time you convey a covered work, the recipient automatically</span>
<span class="sd">receives a license from the original licensors, to run, modify and</span>
<span class="sd">propagate that work, subject to this License.  You are not responsible</span>
<span class="sd">for enforcing compliance by third parties with this License.</span>

<span class="sd">  An &quot;entity transaction&quot; is a transaction transferring control of an</span>
<span class="sd">organization, or substantially all assets of one, or subdividing an</span>
<span class="sd">organization, or merging organizations.  If propagation of a covered</span>
<span class="sd">work results from an entity transaction, each party to that</span>
<span class="sd">transaction who receives a copy of the work also receives whatever</span>
<span class="sd">licenses to the work the party&#39;s predecessor in interest had or could</span>
<span class="sd">give under the previous paragraph, plus a right to possession of the</span>
<span class="sd">Corresponding Source of the work from the predecessor in interest, if</span>
<span class="sd">the predecessor has it or can get it with reasonable efforts.</span>

<span class="sd">  You may not impose any further restrictions on the exercise of the</span>
<span class="sd">rights granted or affirmed under this License.  For example, you may</span>
<span class="sd">not impose a license fee, royalty, or other charge for exercise of</span>
<span class="sd">rights granted under this License, and you may not initiate litigation</span>
<span class="sd">(including a cross-claim or counterclaim in a lawsuit) alleging that</span>
<span class="sd">any patent claim is infringed by making, using, selling, offering for</span>
<span class="sd">sale, or importing the Program or any portion of it.</span>

<span class="sd">  11. Patents.</span>

<span class="sd">  A &quot;contributor&quot; is a copyright holder who authorizes use under this</span>
<span class="sd">License of the Program or a work on which the Program is based.  The</span>
<span class="sd">work thus licensed is called the contributor&#39;s &quot;contributor version&quot;.</span>

<span class="sd">  A contributor&#39;s &quot;essential patent claims&quot; are all patent claims</span>
<span class="sd">owned or controlled by the contributor, whether already acquired or</span>
<span class="sd">hereafter acquired, that would be infringed by some manner, permitted</span>
<span class="sd">by this License, of making, using, or selling its contributor version,</span>
<span class="sd">but do not include claims that would be infringed only as a</span>
<span class="sd">consequence of further modification of the contributor version.  For</span>
<span class="sd">purposes of this definition, &quot;control&quot; includes the right to grant</span>
<span class="sd">patent sublicenses in a manner consistent with the requirements of</span>
<span class="sd">this License.</span>

<span class="sd">  Each contributor grants you a non-exclusive, worldwide, royalty-free</span>
<span class="sd">patent license under the contributor&#39;s essential patent claims, to</span>
<span class="sd">make, use, sell, offer for sale, import and otherwise run, modify and</span>
<span class="sd">propagate the contents of its contributor version.</span>

<span class="sd">  In the following three paragraphs, a &quot;patent license&quot; is any express</span>
<span class="sd">agreement or commitment, however denominated, not to enforce a patent</span>
<span class="sd">(such as an express permission to practice a patent or covenant not to</span>
<span class="sd">sue for patent infringement).  To &quot;grant&quot; such a patent license to a</span>
<span class="sd">party means to make such an agreement or commitment not to enforce a</span>
<span class="sd">patent against the party.</span>

<span class="sd">  If you convey a covered work, knowingly relying on a patent license,</span>
<span class="sd">and the Corresponding Source of the work is not available for anyone</span>
<span class="sd">to copy, free of charge and under the terms of this License, through a</span>
<span class="sd">publicly available network server or other readily accessible means,</span>
<span class="sd">then you must either (1) cause the Corresponding Source to be so</span>
<span class="sd">available, or (2) arrange to deprive yourself of the benefit of the</span>
<span class="sd">patent license for this particular work, or (3) arrange, in a manner</span>
<span class="sd">consistent with the requirements of this License, to extend the patent</span>
<span class="sd">license to downstream recipients.  &quot;Knowingly relying&quot; means you have</span>
<span class="sd">actual knowledge that, but for the patent license, your conveying the</span>
<span class="sd">covered work in a country, or your recipient&#39;s use of the covered work</span>
<span class="sd">in a country, would infringe one or more identifiable patents in that</span>
<span class="sd">country that you have reason to believe are valid.</span>

<span class="sd">  If, pursuant to or in connection with a single transaction or</span>
<span class="sd">arrangement, you convey, or propagate by procuring conveyance of, a</span>
<span class="sd">covered work, and grant a patent license to some of the parties</span>
<span class="sd">receiving the covered work authorizing them to use, propagate, modify</span>
<span class="sd">or convey a specific copy of the covered work, then the patent license</span>
<span class="sd">you grant is automatically extended to all recipients of the covered</span>
<span class="sd">work and works based on it.</span>

<span class="sd">  A patent license is &quot;discriminatory&quot; if it does not include within</span>
<span class="sd">the scope of its coverage, prohibits the exercise of, or is</span>
<span class="sd">conditioned on the non-exercise of one or more of the rights that are</span>
<span class="sd">specifically granted under this License.  You may not convey a covered</span>
<span class="sd">work if you are a party to an arrangement with a third party that is</span>
<span class="sd">in the business of distributing software, under which you make payment</span>
<span class="sd">to the third party based on the extent of your activity of conveying</span>
<span class="sd">the work, and under which the third party grants, to any of the</span>
<span class="sd">parties who would receive the covered work from you, a discriminatory</span>
<span class="sd">patent license (a) in connection with copies of the covered work</span>
<span class="sd">conveyed by you (or copies made from those copies), or (b) primarily</span>
<span class="sd">for and in connection with specific products or compilations that</span>
<span class="sd">contain the covered work, unless you entered into that arrangement,</span>
<span class="sd">or that patent license was granted, prior to 28 March 2007.</span>

<span class="sd">  Nothing in this License shall be construed as excluding or limiting</span>
<span class="sd">any implied license or other defenses to infringement that may</span>
<span class="sd">otherwise be available to you under applicable patent law.</span>

<span class="sd">  12. No Surrender of Others&#39; Freedom.</span>

<span class="sd">  If conditions are imposed on you (whether by court order, agreement or</span>
<span class="sd">otherwise) that contradict the conditions of this License, they do not</span>
<span class="sd">excuse you from the conditions of this License.  If you cannot convey a</span>
<span class="sd">covered work so as to satisfy simultaneously your obligations under this</span>
<span class="sd">License and any other pertinent obligations, then as a consequence you may</span>
<span class="sd">not convey it at all.  For example, if you agree to terms that obligate you</span>
<span class="sd">to collect a royalty for further conveying from those to whom you convey</span>
<span class="sd">the Program, the only way you could satisfy both those terms and this</span>
<span class="sd">License would be to refrain entirely from conveying the Program.</span>

<span class="sd">  13. Use with the GNU Affero General Public License.</span>

<span class="sd">  Notwithstanding any other provision of this License, you have</span>
<span class="sd">permission to link or combine any covered work with a work licensed</span>
<span class="sd">under version 3 of the GNU Affero General Public License into a single</span>
<span class="sd">combined work, and to convey the resulting work.  The terms of this</span>
<span class="sd">License will continue to apply to the part which is the covered work,</span>
<span class="sd">but the special requirements of the GNU Affero General Public License,</span>
<span class="sd">section 13, concerning interaction through a network will apply to the</span>
<span class="sd">combination as such.</span>

<span class="sd">  14. Revised Versions of this License.</span>

<span class="sd">  The Free Software Foundation may publish revised and/or new versions of</span>
<span class="sd">the GNU General Public License from time to time.  Such new versions will</span>
<span class="sd">be similar in spirit to the present version, but may differ in detail to</span>
<span class="sd">address new problems or concerns.</span>

<span class="sd">  Each version is given a distinguishing version number.  If the</span>
<span class="sd">Program specifies that a certain numbered version of the GNU General</span>
<span class="sd">Public License &quot;or any later version&quot; applies to it, you have the</span>
<span class="sd">option of following the terms and conditions either of that numbered</span>
<span class="sd">version or of any later version published by the Free Software</span>
<span class="sd">Foundation.  If the Program does not specify a version number of the</span>
<span class="sd">GNU General Public License, you may choose any version ever published</span>
<span class="sd">by the Free Software Foundation.</span>

<span class="sd">  If the Program specifies that a proxy can decide which future</span>
<span class="sd">versions of the GNU General Public License can be used, that proxy&#39;s</span>
<span class="sd">public statement of acceptance of a version permanently authorizes you</span>
<span class="sd">to choose that version for the Program.</span>

<span class="sd">  Later license versions may give you additional or different</span>
<span class="sd">permissions.  However, no additional obligations are imposed on any</span>
<span class="sd">author or copyright holder as a result of your choosing to follow a</span>
<span class="sd">later version.</span>

<span class="sd">  15. Disclaimer of Warranty.</span>

<span class="sd">  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY</span>
<span class="sd">APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT</span>
<span class="sd">HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM &quot;AS IS&quot; WITHOUT WARRANTY</span>
<span class="sd">OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,</span>
<span class="sd">THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="sd">PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM</span>
<span class="sd">IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF</span>
<span class="sd">ALL NECESSARY SERVICING, REPAIR OR CORRECTION.</span>

<span class="sd">  16. Limitation of Liability.</span>

<span class="sd">  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING</span>
<span class="sd">WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS</span>
<span class="sd">THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY</span>
<span class="sd">GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE</span>
<span class="sd">USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF</span>
<span class="sd">DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD</span>
<span class="sd">PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),</span>
<span class="sd">EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF</span>
<span class="sd">SUCH DAMAGES.</span>

<span class="sd">  17. Interpretation of Sections 15 and 16.</span>

<span class="sd">  If the disclaimer of warranty and limitation of liability provided</span>
<span class="sd">above cannot be given local legal effect according to their terms,</span>
<span class="sd">reviewing courts shall apply local law that most closely approximates</span>
<span class="sd">an absolute waiver of all civil liability in connection with the</span>
<span class="sd">Program, unless a warranty or assumption of liability accompanies a</span>
<span class="sd">copy of the Program in return for a fee.</span>

<span class="sd">                     END OF TERMS AND CONDITIONS</span>

<span class="sd">            How to Apply These Terms to Your New Programs</span>

<span class="sd">  If you develop a new program, and you want it to be of the greatest</span>
<span class="sd">possible use to the public, the best way to achieve this is to make it</span>
<span class="sd">free software which everyone can redistribute and change under these terms.</span>

<span class="sd">  To do so, attach the following notices to the program.  It is safest</span>
<span class="sd">to attach them to the start of each source file to most effectively</span>
<span class="sd">state the exclusion of warranty; and each file should have at least</span>
<span class="sd">the &quot;copyright&quot; line and a pointer to where the full notice is found.</span>

<span class="sd">    &lt;one line to give the program&#39;s name and a brief idea of what it does.&gt;</span>
<span class="sd">    Copyright (C) &lt;year&gt;  &lt;name of author&gt;</span>

<span class="sd">    This program is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    This program is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">Also add information on how to contact you by electronic and paper mail.</span>

<span class="sd">  If the program does terminal interaction, make it output a short</span>
<span class="sd">notice like this when it starts in an interactive mode:</span>

<span class="sd">    &lt;program&gt;  Copyright (C) &lt;year&gt;  &lt;name of author&gt;</span>
<span class="sd">    This program comes with ABSOLUTELY NO WARRANTY; for details type `show w&#39;.</span>
<span class="sd">    This is free software, and you are welcome to redistribute it</span>
<span class="sd">    under certain conditions; type `show c&#39; for details.</span>

<span class="sd">The hypothetical commands `show w&#39; and `show c&#39; should show the appropriate</span>
<span class="sd">parts of the General Public License.  Of course, your program&#39;s commands</span>
<span class="sd">might be different; for a GUI interface, you would use an &quot;about box&quot;.</span>

<span class="sd">  You should also get your employer (if you work as a programmer) or school,</span>
<span class="sd">if any, to sign a &quot;copyright disclaimer&quot; for the program, if necessary.</span>
<span class="sd">For more information on this, and how to apply and follow the GNU GPL, see</span>
<span class="sd">&lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">  The GNU General Public License does not permit incorporating your program</span>
<span class="sd">into proprietary programs.  If your program is a subroutine library, you</span>
<span class="sd">may consider it more useful to permit linking proprietary applications with</span>
<span class="sd">the library.  If this is what you want to do, use the GNU Lesser General</span>
<span class="sd">Public License instead of this License.  But first, please read</span>
<span class="sd">&lt;https://www.gnu.org/licenses/why-not-lgpl.html&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Hanqing Liu<br/>
    
        &copy; Copyright 2019 - 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>